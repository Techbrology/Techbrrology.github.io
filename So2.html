<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Puter Image + Chat Demo</title>

<link
  rel="stylesheet"
  href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
/>

<script src="https://js.puter.com/v2/"></script>

<style>
body { padding: 16px; }
.tab-btn { margin: 4px; }
.preview img {
  max-width: 100%;
  border-radius: 8px;
  margin-top: 10px;
}
.spinner {
  border: 4px solid rgba(0,0,0,.1);
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border-left-color: #09f;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}
@keyframes spin { to { transform: rotate(360deg); } }
.chat-log {
  height: 300px;
  overflow-y: auto;
  border: 1px solid #ddd;
  padding: 8px;
  border-radius: 6px;
}
.msg-user { color: #2563eb; }
.msg-ai { color: #16a34a; }
pre { white-space: pre-wrap; }
</style>
</head>

<body>
<div class="container">

  <h4 class="text-center">Puter Image + Chat (Mobile Safe)</h4>

  <!-- Tabs -->
  <div class="text-center my-2">
    <button class="btn btn-outline-primary tab-btn" onclick="showTab('image')">
      Image Description
    </button>
    <button class="btn btn-outline-primary tab-btn" onclick="showTab('chat')">
      Chat
    </button>
  </div>

  <!-- IMAGE TAB -->
  <div id="imageTab">
    <input type="file" id="imageInput" accept="image/*" class="form-control-file" />
    <button id="describeBtn" class="btn btn-primary mt-2" disabled>
      Describe Image
    </button>

    <div id="preview" class="text-center"></div>
    <div id="imageOutput" class="mt-3"></div>
  </div>

  <!-- CHAT TAB -->
  <div id="chatTab" style="display:none;">
    <div class="chat-log mb-2" id="chatLog"></div>
    <input
      id="chatInput"
      class="form-control"
      placeholder="Type a message…"
    />
  </div>

</div>

<script>
/* ---------- Globals ---------- */
let puterReady = false;
let selectedFile = null;
const imageOutput = document.getElementById("imageOutput");
const preview = document.getElementById("preview");

/* ---------- Wait for Puter ---------- */
(function waitForPuter() {
  if (window.puter && puter.ai) {
    puterReady = true;
  } else {
    setTimeout(waitForPuter, 100);
  }
})();

/* ---------- Utilities ---------- */
function showSpinner(el) {
  el.innerHTML = '<div class="spinner"></div>';
}

function safeText(value) {
  if (typeof value === "string") return value;
  if (value?.text) return value.text;
  if (value?.message) return value.message;
  return JSON.stringify(value, null, 2);
}

function showTab(tab) {
  document.getElementById("imageTab").style.display =
    tab === "image" ? "block" : "none";
  document.getElementById("chatTab").style.display =
    tab === "chat" ? "block" : "none";
}

/* ---------- IMAGE UPLOAD ---------- */
const imageInput = document.getElementById("imageInput");
const describeBtn = document.getElementById("describeBtn");

imageInput.onchange = () => {
  selectedFile = imageInput.files[0];
  imageOutput.innerHTML = "";
  preview.innerHTML = "";

  if (!selectedFile) {
    describeBtn.disabled = true;
    return;
  }

  describeBtn.disabled = false;
  const url = URL.createObjectURL(selectedFile);
  preview.innerHTML = `<img src="${url}" alt="Preview">`;
};

describeBtn.onclick = async () => {
  if (!puterReady || !selectedFile) {
    imageOutput.innerHTML = "AI not ready yet. Try again.";
    return;
  }

  describeBtn.disabled = true;
  showSpinner(imageOutput);

  try {
    const base64 = await fileToBase64(selectedFile);

    const response = await puter.ai.chat(
      "Describe this image in detail.",
      base64,
      { model: "gpt-5-nano", temperature: 0.7 }
    );

    imageOutput.innerHTML = `
      <h6>Image Description</h6>
      <pre>${safeText(response)}</pre>
    `;
  } catch (err) {
    console.error(err);
    imageOutput.innerHTML =
      "<span class='text-danger'>Failed to analyze image.</span>";
  } finally {
    describeBtn.disabled = false;
  }
};

/* ---------- FILE → BASE64 (MOBILE SAFE) ---------- */
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject("File read failed");
    reader.readAsDataURL(file);
  });
}

/* ---------- CHAT ---------- */
const chatLog = document.getElementById("chatLog");
const chatInput = document.getElementById("chatInput");

let chatHistory = [
  { role: "system", content: "You are a helpful assistant." }
];

chatInput.addEventListener("keydown", async e => {
  if (e.key !== "Enter" || !chatInput.value.trim() || !puterReady) return;

  const text = chatInput.value;
  chatInput.value = "";

  addChat("user", text);
  chatHistory.push({ role: "user", content: text });

  const aiDiv = addChat("ai", "…");

  try {
    const response = await puter.ai.chat(chatHistory, false, {
      model: "gpt-5-nano",
      temperature: 0.7
    });

    const reply = safeText(response);
    aiDiv.textContent = reply;
    chatHistory.push({ role: "assistant", content: reply });
  } catch (err) {
    aiDiv.textContent = "Error getting response.";
  }
});

function addChat(role, text) {
  const div = document.createElement("div");
  div.className = role === "user" ? "msg-user" : "msg-ai";
  div.textContent = (role === "user" ? "You: " : "AI: ") + text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
  return div;
}
</script>
</body>
</html>
