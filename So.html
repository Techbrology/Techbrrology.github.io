<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Puter Image Description (Safe)</title>

<link
  rel="stylesheet"
  href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
/>

<script src="https://js.puter.com/v2/"></script>

<style>
body { padding: 20px; }
.preview img {
  max-width: 100%;
  border-radius: 8px;
  margin-top: 10px;
}
.spinner {
  border: 4px solid rgba(0,0,0,.1);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border-left-color: #09f;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}
@keyframes spin { to { transform: rotate(360deg); } }
pre { white-space: pre-wrap; }
</style>
</head>

<body>
<div class="container">
  <h3 class="text-center">Image Description (Puter â€“ Safe Mode)</h3>
  <p class="text-center text-muted">
    Upload any image. This version safely extracts text from all Puter responses.
  </p>

  <div class="text-center my-3">
    <input
      type="file"
      id="imageInput"
      accept="image/*"
      class="form-control-file"
    />
  </div>

  <div class="text-center">
    <button id="submit" class="btn btn-primary" disabled>
      Describe Image
    </button>
  </div>

  <div class="preview text-center" id="preview"></div>
  <div id="output" class="mt-4"></div>
</div>

<script>
const imageInput = document.getElementById("imageInput");
const submitButton = document.getElementById("submit");
const outputDiv = document.getElementById("output");
const previewDiv = document.getElementById("preview");

let selectedFile = null;

/* ---------- Helpers ---------- */

function showSpinner() {
  outputDiv.innerHTML = '<div class="spinner"></div>';
}

function safeText(value) {
  // GUARANTEE STRING OUTPUT
  if (typeof value === "string") return value;
  if (value?.text && typeof value.text === "string") return value.text;
  if (value?.message && typeof value.message === "string") return value.message;
  return JSON.stringify(value, null, 2);
}

/* ---------- Image Upload ---------- */

imageInput.onchange = () => {
  selectedFile = imageInput.files[0];
  outputDiv.innerHTML = "";
  previewDiv.innerHTML = "";

  if (!selectedFile) {
    submitButton.disabled = true;
    return;
  }

  submitButton.disabled = false;

  const url = URL.createObjectURL(selectedFile);
  previewDiv.innerHTML = `<img src="${url}" alt="Preview">`;
};

/* ---------- Main AI Call ---------- */

submitButton.onclick = async () => {
  if (!selectedFile) return;

  submitButton.disabled = true;
  showSpinner();

  try {
    // Convert image to base64
    const reader = new FileReader();
    reader.onload = async () => {
      const imageData = reader.result;

      // Call Puter (FREE-FRIENDLY MODEL)
      const response = await puter.ai.chat(
        "Describe this image in detail.",
        imageData,
        {
          model: "gpt-5-nano",
          temperature: 0.7
        }
      );

      const text = safeText(response);

      outputDiv.innerHTML = `
        <h5>Image Description</h5>
        <pre>${text}</pre>
      `;

      submitButton.disabled = false;
    };

    reader.readAsDataURL(selectedFile);

  } catch (err) {
    console.error(err);
    outputDiv.innerHTML =
      "<div class='text-danger'>Error generating description.</div>";
    submitButton.disabled = false;
  }
};
</script>
</body>
</html>
